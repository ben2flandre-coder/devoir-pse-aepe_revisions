<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>CAP AEPE ‚Äì Devoir PSE V3 Professionnel</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a31;
      --text:#e8eefc;
      --muted:#a9b7da;
      --line:rgba(255,255,255,.10);
      --accent:#5dd6ff;
      --accent2:#9bffb5;
      --warn:#ffd166;
      --danger:#ff5d7a;
      --ok:#36f097;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8ff;
        --card:#ffffff;
        --text:#0b1220;
        --muted:#3c4a6b;
        --line:rgba(10,20,40,.10);
        --shadow: 0 18px 60px rgba(10,20,40,.12);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(93,214,255,.18), transparent 60%),
        radial-gradient(900px 600px at 90% 15%, rgba(155,255,181,.14), transparent 55%),
        radial-gradient(1000px 700px at 30% 90%, rgba(255,209,102,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      font-size:16px;
      line-height:1.45;
      -webkit-tap-highlight-color: transparent;
    }
    .container{max-width:1200px; margin:0 auto; padding:16px 14px 84px}
    .hero{
      position:relative;
      border:1px solid var(--line);
      border-radius:22px;
      overflow:hidden;
      box-shadow:var(--shadow);
      background: linear-gradient(135deg, rgba(93,214,255,.12), rgba(155,255,181,.10) 55%, rgba(255,209,102,.08));
    }
    .heroTop{
      display:flex;
      gap:14px;
      align-items:stretch;
      flex-wrap:wrap;
      padding:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-bottom:1px solid var(--line);
    }
    .heroLogo{display:flex; align-items:center; gap:12px; flex: 1 1 520px; min-width: 320px}
    .logoImg{height:42px; width:auto; display:block; filter: drop-shadow(0 8px 18px rgba(0,0,0,.25))}
    .heroTitle h1{margin:0; font-size:20px; letter-spacing:.2px}
    .heroTitle p{margin:6px 0 0; color:var(--muted); font-size:13px}
    .heroMeta{flex: 0 0 340px; min-width: 280px; display:flex; flex-direction:column; justify-content:space-between; gap:10px}
    .chips{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(255,255,255,.04); font-size:12px; color:var(--muted); user-select:none; white-space:nowrap}
    .chip b{color:var(--text)}
    .heroActions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{appearance:none; border:1px solid var(--line); background: rgba(255,255,255,.06); color: var(--text); padding: 10px 12px; border-radius: 14px; cursor:pointer; font-weight:800; font-size: 13px; display:inline-flex; align-items:center; gap:10px; user-select:none; transition: transform .05s ease, background .2s ease}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: rgba(93,214,255,.16); border-color: rgba(93,214,255,.35)}
    .btn.ok{background: rgba(54,240,151,.14); border-color: rgba(54,240,151,.35)}
    .btn.warn{background: rgba(255,209,102,.14); border-color: rgba(255,209,102,.35)}
    .btn.danger{background: rgba(255,93,122,.12); border-color: rgba(255,93,122,.35)}
    .btn[disabled]{opacity:.55; cursor:not-allowed}
    .heroNav{padding: 10px 16px 14px; display:flex; gap:10px; flex-wrap:wrap}
    .tab{border:1px solid var(--line); background: rgba(0,0,0,.12); padding: 8px 12px; border-radius: 999px; font-weight:800; font-size: 12px; color: var(--muted); cursor:pointer; transition: all .2s ease}
    .tab.active{color: var(--text); border-color: rgba(93,214,255,.35); background: rgba(93,214,255,.10)}
    .layout{margin-top: 16px; display:grid; grid-template-columns: 1.25fr .75fr; gap: 16px; align-items:start}
    @media (max-width: 980px){ .layout{grid-template-columns: 1fr} }
    .card{border:1px solid var(--line); background: rgba(255,255,255,.03); border-radius: var(--radius); box-shadow: var(--shadow); overflow:hidden}
    .cardHeader{padding: 14px 16px 12px; border-bottom: 1px solid var(--line); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02))}
    .cardHeader h2{margin:0; font-size:15px; letter-spacing:.2px}
    .cardHeader p{margin:6px 0 0; color:var(--muted); font-size:13px}
    .cardBody{padding: 16px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap: 10px}
    @media (max-width: 560px){ .row{grid-template-columns: 1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom: 6px}
    input[type="text"], input[type="email"], input[type="date"], textarea, select{width:100%; padding: 12px 12px; border-radius: 12px; border: 1px solid var(--line); background: rgba(0,0,0,.15); color: var(--text); outline:none; font-size:16px}
    @media (prefers-color-scheme: light){ input[type="text"], input[type="email"], input[type="date"], textarea, select{background: rgba(10,20,40,.04)} }
    textarea{min-height: 108px; resize: vertical; font-family: var(--font)}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(255,255,255,.04); color:var(--muted)}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top: 10px}
    .divider{height:1px; background: var(--line); margin: 14px 0}
    .hint{margin:10px 0 0; font-size:12px; color: var(--muted)}
    .progressWrap{display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-top: 12px}
    .progress{height:10px; border-radius:999px; background: rgba(255,255,255,.06); border:1px solid var(--line); overflow:hidden; flex:1}
    .bar{height:100%; width:0%; background: linear-gradient(90deg, rgba(93,214,255,.95), rgba(155,255,181,.95)); border-radius:999px; transition: width .25s ease}
    details{border-top:1px solid var(--line); padding: 14px 0}
    summary{cursor:pointer; list-style:none; display:flex; align-items:flex-start; justify-content:space-between; gap: 12px}
    summary::-webkit-details-marker{display:none}
    .qTitle{display:flex; gap:10px; align-items:flex-start; min-width:0}
    .qNum{flex:0 0 auto; width:34px; height:34px; border-radius: 12px; display:grid; place-items:center; font-weight:900; background: rgba(93,214,255,.14); border: 1px solid rgba(93,214,255,.26)}
    .qMeta{min-width:0}
    .qMeta .t{font-weight:900; font-size:14px; margin:0}
    .qMeta .s{margin:4px 0 0; color:var(--muted); font-size:12px}
    .qRight{display:flex; gap:8px; align-items:center; flex:0 0 auto}
    .tag{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(255,255,255,.04); color: var(--muted)}
    .tag.kpi{border-color: rgba(155,255,181,.35); background: rgba(155,255,181,.10)}
    .tag.risk{border-color: rgba(255,93,122,.35); background: rgba(255,93,122,.08)}
    .tag.doc{border-color: rgba(255,209,102,.35); background: rgba(255,209,102,.10)}
    .tag.pro{border-color: rgba(93,214,255,.35); background: rgba(93,214,255,.10)}
    .qBody{margin-top: 12px; padding-left: 44px}
    .scenario{border:1px solid var(--line); background: rgba(255,255,255,.03); border-radius: 14px; padding: 12px; margin: 10px 0 12px}
    .scenario .h{margin:0; font-size:12px; letter-spacing:.3px; color: var(--muted); text-transform: uppercase}
    .scenario .p{margin:8px 0 0; font-size:14px}
    .choices{display:grid; gap: 8px; margin-top: 10px}
    .choice{border:1px solid var(--line); background: rgba(255,255,255,.03); border-radius: 14px; padding: 10px 12px; display:flex; align-items:flex-start; gap:10px; cursor:pointer; transition: background .2s ease, border-color .2s ease}
    .choice:hover{background: rgba(255,255,255,.06); border-color: rgba(93,214,255,.25)}
    .choice input{margin-top:3px; transform: scale(1.1); cursor:pointer}
    .choice .ct{display:flex; flex-direction:column; gap:2px; flex:1}
    .choice .ct .a{font-weight:800; font-size:14px}
    .help{font-size:12px; color:var(--muted); margin-top: 10px; padding-left: 44px}
    .results{display:none; margin-top: 10px}
    .results.show{display:block}
    .panel{border:1px solid var(--line); border-radius: var(--radius); background: rgba(255,255,255,.03); padding: 14px; margin-top: 12px}
    .scoreBig{display:flex; align-items:flex-end; justify-content:space-between; gap: 12px; flex-wrap:wrap}
    .scoreBig .n{font-size:40px; font-weight:950; letter-spacing:-.8px; margin:0}
    .scoreBig .n span{font-size:16px; color: var(--muted); font-weight:900}
    .scoreBig .meta{margin:0; color: var(--muted); font-size:13px}
    .kpiRow{display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px}
    @media (max-width: 720px){ .kpiRow{grid-template-columns: 1fr} }
    .kpi{border:1px solid var(--line); border-radius: 14px; background: rgba(255,255,255,.03); padding: 12px}
    .kpi .k{font-size:12px; color: var(--muted); margin:0}
    .kpi .v{margin:6px 0 0; font-weight:950; font-size:18px}
    .corrList{margin-top: 10px; display:grid; gap: 10px}
    .corrItem{border:1px solid var(--line); border-radius: 14px; background: rgba(255,255,255,.03); padding: 12px}
    .corrItem .topline{display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap:wrap}
    .chipRes{font-size:12px; padding:6px 10px; border-radius:999px; font-weight:950; border:1px solid var(--line); background: rgba(255,255,255,.04)}
    .chipRes.ok{border-color: rgba(54,240,151,.40); background: rgba(54,240,151,.12)}
    .chipRes.no{border-color: rgba(255,93,122,.40); background: rgba(255,93,122,.10)}
    .corrItem h4{margin: 10px 0 6px; font-size: 14px}
    .corrItem p{margin:0; color: var(--muted); font-size: 13px}
    .sticky{position: sticky; top: 14px}
    @media (max-width: 980px){ .sticky{position: static} }
    .infobox{border:1px solid rgba(93,214,255,.35); background: rgba(93,214,255,.08); border-radius: 16px; padding: 18px; margin: 18px 0}
    .infobox h3{margin:0 0 12px; font-size:15px; color:var(--accent); display:flex; align-items:center; gap:10px}
    .infobox ul{margin:8px 0 0 20px; color:var(--text); line-height:1.7}
    .infobox ul li{margin:6px 0}
    .exemple{border:1px solid rgba(155,255,181,.35); background: rgba(155,255,181,.08); border-radius: 14px; padding: 14px; margin-top: 14px}
    .exemple h4{margin:0 0 8px; font-size:13px; color:var(--accent2); text-transform: uppercase; letter-spacing: .5px}
    .exemple p{margin:6px 0; font-size:13px}
    .tagLegend{display:flex; gap:12px; flex-wrap:wrap; margin:14px 0; padding:14px; border:1px solid var(--line); border-radius: 12px; background: rgba(255,255,255,.02)}
    .tagLegend > div{display:flex; align-items:center; gap:8px}
    .visualImg{width:100%; height:auto; border-radius:12px; margin:10px 0; border:1px solid var(--line); box-shadow: 0 8px 24px rgba(0,0,0,.2)}
    .imgCaption{font-size:11px; color:var(--muted); text-align:center; margin:-6px 0 10px; font-style:italic}
    .foot{margin-top: 18px; color: var(--muted); font-size: 12px}
  </style>
</head>

<body>
  <div class="container">
    <header class="hero">
      <div class="heroTop">
        <div class="heroLogo">
          <svg class="logoImg" width="180" height="42" viewBox="0 0 180 42" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="180" height="42" rx="8" fill="#5dd6ff" fill-opacity="0.15"/>
            <text x="12" y="28" fill="currentColor" font-family="system-ui" font-weight="900" font-size="18">GIP-FIPAN</text>
          </svg>
          <div class="heroTitle">
            <h1>CAP AEPE ‚Äì DEVOIR PSE V3</h1>
            <p>Bloc 1 ‚Äì Pr√©vention Sant√© Environnement. √âvaluation professionnalisante.</p>
          </div>
        </div>

        <div class="heroMeta">
          <div class="chips">
            <div class="chip"><b>Bar√®me</b>&nbsp;/20</div>
            <div class="chip"><b>Format</b>&nbsp;interactif</div>
            <div class="chip"><b>Sortie</b>&nbsp;e-mail</div>
          </div>
          <div class="heroActions">
            <button class="btn primary" id="btnGoConsignes">üìã Consignes</button>
            <button class="btn" id="btnGoQuestions">üìù Questions</button>
            <button class="btn ok" id="btnGoResults" disabled>‚úÖ R√©sultats</button>
          </div>
        </div>
      </div>

      <nav class="heroNav">
        <button class="tab active" data-filter="all">Tout</button>
        <button class="tab" data-filter="sst">Gestes & secours</button>
        <button class="tab" data-filter="infectieux">Hygi√®ne / infectieux</button>
        <button class="tab" data-filter="ppms">Incendie & PPMS</button>
        <button class="tab" data-filter="tms">TMS / ergonomie</button>
        <button class="tab" data-filter="cadre">Cadre pro</button>
      </nav>
    </header>

    <!-- CONSIGNES -->
    <section class="card" id="sectionConsignes" style="margin-top:16px;">
      <div class="cardHeader">
        <h2>üìã Consignes et objectifs du devoir</h2>
        <p>Lis attentivement avant de commencer. Ce devoir √©value ta capacit√© √† analyser des situations professionnelles r√©elles.</p>
      </div>
      <div class="cardBody">
        <div class="infobox">
          <h3>üéØ Objectif g√©n√©ral</h3>
          <p>D√©montrer que tu sais :</p>
          <ul>
            <li><strong>Observer</strong> : rep√©rer les faits, distinguer observation et interpr√©tation</li>
            <li><strong>Analyser</strong> : identifier les causes (mat√©riel, organisation, humain), mobiliser tes connaissances PSE</li>
            <li><strong>Agir</strong> : proposer des mesures de pr√©vention hi√©rarchis√©es, tracer, communiquer</li>
          </ul>
        </div>

        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='200' viewBox='0 0 800 200'%3E%3Crect fill='%230f1a31' width='800' height='200'/%3E%3Cg fill='none' stroke='%235dd6ff' stroke-width='2'%3E%3Ccircle cx='150' cy='100' r='60' opacity='0.3'/%3E%3Cpath d='M150 60 L150 100 L180 80' stroke-linecap='round'/%3E%3Ctext x='150' y='170' fill='%23a9b7da' font-family='system-ui' font-size='14' text-anchor='middle'%3EOBSERVER%3C/text%3E%3C/g%3E%3Cg fill='none' stroke='%239bffb5' stroke-width='2'%3E%3Ccircle cx='400' cy='100' r='60' opacity='0.3'/%3E%3Cpath d='M370 100 L400 70 L430 100 L400 130 Z' stroke-linejoin='round'/%3E%3Ctext x='400' y='170' fill='%23a9b7da' font-family='system-ui' font-size='14' text-anchor='middle'%3EANALYSER%3C/text%3E%3C/g%3E%3Cg fill='none' stroke='%23ffd166' stroke-width='2'%3E%3Ccircle cx='650' cy='100' r='60' opacity='0.3'/%3E%3Cpath d='M630 110 L645 95 L680 110' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ctext x='650' y='170' fill='%23a9b7da' font-family='system-ui' font-size='14' text-anchor='middle'%3EAGIR%3C/text%3E%3C/g%3E%3Cpath d='M210 100 L340 100' stroke='%23a9b7da' stroke-width='2' stroke-dasharray='5,5' marker-end='url(%23arrow)'/%3E%3Cpath d='M460 100 L590 100' stroke='%23a9b7da' stroke-width='2' stroke-dasharray='5,5' marker-end='url(%23arrow)'/%3E%3Cdefs%3E%3Cmarker id='arrow' markerWidth='10' markerHeight='10' refX='5' refY='3' orient='auto' markerUnits='strokeWidth'%3E%3Cpath d='M0,0 L0,6 L9,3 z' fill='%23a9b7da'/%3E%3C/marker%3E%3C/defs%3E%3C/svg%3E" alt="D√©marche PSE" class="visualImg" />
        <p class="imgCaption">D√©marche professionnelle PSE : Observer les faits ‚Üí Analyser les causes ‚Üí Agir avec m√©thode</p>

        <div class="infobox">
          <h3>üìù Types de questions</h3>
          <ul>
            <li><strong>QCU (choix unique)</strong> : Une seule r√©ponse juste</li>
            <li><strong>QCM (choix multiple)</strong> : Plusieurs r√©ponses attendues</li>
            <li><strong>R√©ponses courtes</strong> : 4 √† 8 lignes, posture professionnelle</li>
          </ul>
        </div>

        <div class="infobox">
          <h3>‚úÖ Ce qui est valoris√©</h3>
          <ul>
            <li>Vocabulaire professionnel (DUERP, EPI, pr√©vention primaire, tra√ßabilit√©)</li>
            <li>Logique de pr√©vention : agir √† la source > organiser > prot√©ger > informer</li>
            <li>Faits observables (√©viter jugements de valeur)</li>
            <li>Mesures concr√®tes, r√©alistes, applicables</li>
          </ul>
        </div>

        <div class="tagLegend">
          <strong style="width:100%; font-size:13px; margin-bottom:6px;">üè∑Ô∏è L√©gende des tags</strong>
          <div><span class="tag risk">RISK</span> <span style="font-size:12px; color:var(--muted);">Analyse du risque</span></div>
          <div><span class="tag pro">PRO</span> <span style="font-size:12px; color:var(--muted);">Posture m√©tier</span></div>
          <div><span class="tag kpi">KPI</span> <span style="font-size:12px; color:var(--muted);">Indicateur de ma√Ætrise</span></div>
          <div><span class="tag doc">DOC</span> <span style="font-size:12px; color:var(--muted);">R√©f√©rence documentaire</span></div>
        </div>

        <div class="exemple">
          <h4>üí° Exemple de r√©ponse attendue</h4>
          <p><strong>Question (fictive) :</strong> Un enfant tombe en courant. D√©cris la conduite √† tenir.</p>
          <p style="font-style:italic; background:rgba(0,0,0,.15); padding:10px; border-radius:8px; margin-top:6px;">
            J'√©value imm√©diatement l'√©tat de l'enfant (conscience, respiration, plaie). Si besoin, j'applique les gestes de premiers secours et j'alerte (15 ou √©quipe). Je s√©curise la zone. Je trace l'incident dans le registre (heure, circonstances, actions men√©es). Ensuite, j'analyse les causes : sol glissant ? circulation encombr√©e ? Je propose des mesures (organisation, am√©nagement) et je communique √† l'√©quipe.
          </p>
          <p style="margin-top:8px; font-size:12px; color:var(--muted);">
            ‚úÖ Vocabulaire m√©tier ‚Ä¢ Structure claire ‚Ä¢ Mesures concr√®tes ‚Ä¢ Tra√ßabilit√© ‚Ä¢ Pr√©vention
          </p>
        </div>
      </div>
    </section>

    <div class="layout">
      <!-- CARTOUCHE -->
      <section class="card" id="sectionCartouche">
        <div class="cardHeader">
          <h2>Cartouche candidat (obligatoire)</h2>
          <p>Tra√ßabilit√© et correction s√©curis√©e.</p>
        </div>
        <div class="cardBody">
          <div class="row">
            <div><label for="nom">Nom</label><input id="nom" type="text" placeholder="DURAND" /></div>
            <div><label for="prenom">Pr√©nom</label><input id="prenom" type="text" placeholder="L√©a" /></div>
            <div><label for="classe">Classe / Groupe</label><input id="classe" type="text" placeholder="CAP AEPE 1" /></div>
            <div><label for="date">Date</label><input id="date" type="date" /></div>
            <div><label for="emailFormateur">Email formateur</label><input id="emailFormateur" type="email" value="benoit.deflandre@ac-nice.fr" /></div>
            <div>
              <label for="mode">Mode</label>
              <select id="mode">
                <option value="devoir">Devoir (feedback synth√©tique)</option>
                <option value="entrainement">Entra√Ænement (feedback d√©taill√©)</option>
              </select>
            </div>
          </div>

          <div class="inline">
            <button class="btn primary" id="btnLock">üîí Verrouiller</button>
            <button class="btn" id="btnUnlock" disabled>üîì D√©verrouiller</button>
            <div class="pill" id="lockState">Statut : <b>non verrouill√©</b></div>
          </div>

          <div class="progressWrap">
            <div class="progress"><div class="bar" id="bar"></div></div>
            <div class="pill" id="progressText">Progression : <b>0%</b></div>
          </div>
        </div>
      </section>

      <!-- PILOTAGE -->
      <aside class="card sticky" id="sectionPilotage">
        <div class="cardHeader">
          <h2>Pilotage</h2>
          <p>Correction et synth√®se.</p>
        </div>
        <div class="cardBody">
          <button class="btn ok" id="btnCorrect" disabled style="width:100%; justify-content:center;">‚úÖ Corriger</button>

          <div class="inline" style="margin-top:10px;">
            <button class="btn" id="btnCollapse">üß© Replier</button>
            <button class="btn danger" id="btnReset">üß® R√©initialiser</button>
          </div>

          <div class="results" id="results">
            <div class="panel">
              <div class="scoreBig">
                <p class="n" id="scoreBig">‚Äî <span>/20</span></p>
                <p class="meta" id="scoreMeta">‚Äî</p>
              </div>

              <div class="kpiRow">
                <div class="kpi"><p class="k">Questions valid√©es</p><p class="v" id="kpiOk">‚Äî</p></div>
                <div class="kpi"><p class="k">Points obtenus</p><p class="v" id="kpiPts">‚Äî</p></div>
                <div class="kpi"><p class="k">Taux r√©ussite</p><p class="v" id="kpiRate">‚Äî</p></div>
              </div>

              <div class="divider"></div>

              <button class="btn primary" id="btnMail" style="width:100%; justify-content:center;">‚úâÔ∏è G√©n√©rer mail</button>
              <div class="inline" style="margin-top:10px;">
                <button class="btn" id="btnCopy">üìã Copier</button>
                <div class="pill" id="copyState">Copie : <b>‚Äî</b></div>
              </div>
            </div>

            <div class="panel">
              <h3 style="margin:0 0 10px; font-size:15px;">Synth√®se de correction</h3>
              <div class="corrList" id="corrList"></div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- QUESTIONS -->
    <section class="card" id="sectionQuestions" style="margin-top:16px;">
      <div class="cardHeader">
        <h2>Questions ‚Äì situations professionnelles AEPE</h2>
        <p>Analyse de contextes r√©els en structure petite enfance.</p>
      </div>
      <div class="cardBody" id="questions"></div>
    </section>
  </div>

<script>
const QUESTIONS = [
  {
    id: "q1", type: "mcq", points: 1, theme:"cadre", tags:["pro","kpi"],
    title: "Document Unique : pour quoi faire sur le terrain ?",
    subtitle: "Logique pr√©vention, pas conformit√© administrative.",
    scenario: "Tu es en stage dans une cr√®che collective (15 enfants, 4 pros). La directrice te montre le DUERP actualis√©. Elle te demande en quoi ce document aide l'√©quipe au quotidien.",
    prompt: "Quelle proposition refl√®te le mieux l'usage op√©rationnel du DUERP ?",
    choices: [
      { key:"A", a:"Il remplace le r√®glement int√©rieur et d√©finit les sanctions" },
      { key:"B", a:"Il identifie les risques, les √©value, et planifie des actions de pr√©vention hi√©rarchis√©es" },
      { key:"C", a:"Il liste uniquement les produits d'entretien et leur dangerosit√©" },
      { key:"D", a:"Il sert uniquement lors des contr√¥les de l'inspection du travail" },
    ],
    answer:["B"],
    rationale:"Le DUERP est un outil de pilotage pr√©vention : rep√©rage ‚Üí √©valuation ‚Üí actions ‚Üí suivi. Il sert au quotidien pour prioriser les mesures.",
    image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='200' viewBox='0 0 600 200'%3E%3Crect fill='%230f1a31' width='600' height='200'/%3E%3Crect x='50' y='40' width='150' height='120' rx='8' fill='%235dd6ff' fill-opacity='0.1' stroke='%235dd6ff' stroke-width='2'/%3E%3Ctext x='125' y='70' fill='%23e8eefc' font-family='system-ui' font-size='14' font-weight='700' text-anchor='middle'%3EDUERP%3C/text%3E%3Ctext x='125' y='95' fill='%23a9b7da' font-family='system-ui' font-size='11' text-anchor='middle'%3EIdentifier%3C/text%3E%3Ctext x='125' y='115' fill='%23a9b7da' font-family='system-ui' font-size='11' text-anchor='middle'%3E√âvaluer%3C/text%3E%3Ctext x='125' y='135' fill='%23a9b7da' font-family='system-ui' font-size='11' text-anchor='middle'%3EPlanifier%3C/text%3E%3Cpath d='M200 100 L350 100' stroke='%23ffd166' stroke-width='2' marker-end='url(%23arrow)'/%3E%3Crect x='350' y='60' width='200' height='80' rx='8' fill='%239bffb5' fill-opacity='0.1' stroke='%239bffb5' stroke-width='2'/%3E%3Ctext x='450' y='95' fill='%23e8eefc' font-family='system-ui' font-size='12' text-anchor='middle'%3EACTIONS%3C/text%3E%3Ctext x='450' y='115' fill='%23a9b7da' font-family='system-ui' font-size='11' text-anchor='middle'%3EPR√âVENTION%3C/text%3E%3Cdefs%3E%3Cmarker id='arrow' markerWidth='10' markerHeight='10' refX='5' refY='3' orient='auto'%3E%3Cpath d='M0,0 L0,6 L9,3 z' fill='%23ffd166'/%3E%3C/marker%3E%3C/defs%3E%3C/svg%3E"
  },
  {
    id:"q2", type:"msq", points: 1.5, theme:"cadre", tags:["risk","doc"],
    title:"Quasi-accident : capitaliser pour progresser",
    subtitle:"Tra√ßabilit√© et am√©lioration continue.",
    scenario:"14h30, salle de jeux (section 18‚Äì36 mois). Une auxiliaire glisse sur une flaque d'eau pr√®s du point d'eau (activit√© peinture termin√©e). Pas de chute, juste un d√©s√©quilibre. L'√©quipe termine sans en reparler.",
    prompt:"Quelles actions correspondent √† une d√©marche professionnelle ? (plusieurs r√©ponses)",
    choices:[
      {key:"A", a:"Organiser un retour d'exp√©rience : faits, causes possibles, mesures correctives"},
      {key:"B", a:"Ne rien √©crire puisqu'il n'y a pas eu de blessure"},
      {key:"C", a:"Ajuster l'organisation : s√©chage imm√©diat, s√©paration des zones, signalisation"},
      {key:"D", a:"Bl√¢mer l'enfant qui a renvers√© le pot d'eau"}
    ],
    answer:["A","C"],
    rationale:"La pr√©vention repose sur la tra√ßabilit√© des incidents (m√™me sans blessure) et l'action sur l'environnement. La culture s√©curit√© √©vite la sous-d√©claration.",
    image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='200' viewBox='0 0 600 200'%3E%3Crect fill='%230f1a31' width='600' height='200'/%3E%3Ccircle cx='150' cy='100' r='50' fill='%23ff5d7a' fill-opacity='0.1' stroke='%23ff5d7a' stroke-width='2'/%3E%3Cpath d='M130 100 L150 80 L170 100' stroke='%23ff5d7a' stroke-width='3' stroke-linecap='round' fill='none'/%3E%3Ctext x='150' y='165' fill='%23a9b7da' font-family='system-ui' font-size='12' text-anchor='middle'%3EINCIDENT%3C/text%3E%3Cpath d='M200 100 L280 100' stroke='%23ffd166' stroke-width='2' marker-end='url(%23arrow2)'/%3E%3Crect x='280' y='70' width='120' height='60' rx='8' fill='%235dd6ff' fill-opacity='0.1' stroke='%235dd6ff' stroke-width='2'/%3E%3Ctext x='340' y='95' fill='%23e8eefc' font-family='system-ui' font-size='11' text-anchor='middle'%3ETRACER%3C/text%3E%3Ctext x='340' y='115' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3E+ analyser%3C/text%3E%3Cpath d='M400 100 L480 100' stroke='%23ffd166' stroke-width='2' marker-end='url(%23arrow2)'/%3E%3Crect x='480' y='70' width='100' height='60' rx='8' fill='%239bffb5' fill-opacity='0.1' stroke='%239bffb5' stroke-width='2'/%3E%3Ctext x='530' y='105' fill='%23e8eefc' font-family='system-ui' font-size='11' text-anchor='middle'%3EACTION%3C/text%3E%3Cdefs%3E%3Cmarker id='arrow2' markerWidth='10' markerHeight='10' refX='5' refY='3' orient='auto'%3E%3Cpath d='M0,0 L0,6 L9,3 z' fill='%23ffd166'/%3E%3C/marker%3E%3C/defs%3E%3C/svg%3E"
  },
  {
    id:"q3", type:"mcq", points: 1, theme:"infectieux", tags:["risk","pro"],
    title:"Hygi√®ne des mains : quand friction, quand lavage ?",
    subtitle:"Protocole simple, efficacit√© maximale.",
    scenario:"9h15, cr√®che collective. Tu viens d'aider un enfant aux toilettes (change couche). Tes mains sont visiblement propres. Tu dois maintenant pr√©parer les biberons.",
    prompt:"Quelle affirmation est correcte ?",
    choices:[
      {key:"A", a:"Les gants remplacent l'hygi√®ne des mains"},
      {key:"B", a:"La friction hydro-alcoolique est possible sur mains visiblement propres, sauf apr√®s contact avec liquides biologiques"},
      {key:"C", a:"Le lavage est inutile si j'ai port√© des gants pendant le change"},
      {key:"D", a:"Je me lave les mains seulement en fin de matin√©e"}
    ],
    answer:["B"],
    rationale:"R√®gle PSE : friction SHA si mains visiblement propres et s√®ches (hors soins invasifs). Lavage si mains sales ou apr√®s contact liquides biologiques. Les gants ne remplacent jamais l'hygi√®ne des mains.",
    image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='200' viewBox='0 0 600 200'%3E%3Crect fill='%230f1a31' width='600' height='200'/%3E%3Cg%3E%3Crect x='50' y='50' width='200' height='100' rx='8' fill='%235dd6ff' fill-opacity='0.1' stroke='%235dd6ff' stroke-width='2'/%3E%3Ctext x='150' y='80' fill='%23e8eefc' font-family='system-ui' font-size='13' font-weight='700' text-anchor='middle'%3ELAVAGE%3C/text%3E%3Ctext x='150' y='100' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3EMains sales%3C/text%3E%3Ctext x='150' y='115' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3ELiquides biologiques%3C/text%3E%3Ctext x='150' y='130' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3EAvant repas%3C/text%3E%3C/g%3E%3Cg%3E%3Crect x='350' y='50' width='200' height='100' rx='8' fill='%239bffb5' fill-opacity='0.1' stroke='%239bffb5' stroke-width='2'/%3E%3Ctext x='450' y='80' fill='%23e8eefc' font-family='system-ui' font-size='13' font-weight='700' text-anchor='middle'%3EFRICTION SHA%3C/text%3E%3Ctext x='450' y='100' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3EMains propres%3C/text%3E%3Ctext x='450' y='115' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3EEntre 2 gestes%3C/text%3E%3Ctext x='450' y='130' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3ERapide%3C/text%3E%3C/g%3E%3C/svg%3E"
  },
  {
    id:"q4", type:"short", points: 1.5, theme:"infectieux", tags:["pro","kpi"],
    title:"Port de gants : adapter la protection au risque r√©el",
    subtitle:"EPI pertinent, pas syst√©matique.",
    scenario:"10h, MAM (maison d'assistantes maternelles). Tu enchaines : change d'un enfant (gastro-ent√©rite), puis pr√©paration d'une activit√© p√¢te √† modeler avec 3 autres enfants.",
    prompt:"R√©dige une r√©ponse structur√©e (4‚Äì6 lignes) : cite 2 situations o√π le port de gants est justifi√© + 1 situation o√π il ne l'est pas, et explique pourquoi.",
    answerShort:{
      mustIncludeAny:[
        ["sang","liquide biologique","vomissement","selles","urine","plaie","exsudat"],
        ["peau l√©s√©e","coupure","l√©sion","dermatite","ecz√©ma"],
        ["p√¢te","modeler","jeux","activit√©","non justifi√©"]
      ],
      avoid:["toujours","tout le temps","jamais"],
      minWords: 30
    },
    rationale:"Attendu : EPI adapt√© au risque (liquides biologiques, peau l√©s√©e du professionnel). Les gants ne remplacent jamais l'hygi√®ne des mains. Usage raisonn√© = efficacit√© + √©conomie."
  },
  {
    id:"q5", type:"mcq", points: 1, theme:"sst", tags:["pro","risk"],
    title:"Accident d'exposition au sang (AES) : conduite imm√©diate",
    subtitle:"Proc√©dure post-exposition = urgence.",
    scenario:"11h30, micro-cr√®che. Pendant un soin (d√©sinfection plaie au genou), projection de sang dans ton ≈ìil gauche.",
    prompt:"Quelle est la conduite √† tenir en premier ?",
    choices:[
      {key:"A", a:"Attendre la fin du service pour consulter"},
      {key:"B", a:"Rincer imm√©diatement et abondamment √† l'eau (15 min minimum), alerter le responsable, tracer l'incident, suivre la proc√©dure AES"},
      {key:"C", a:"Mettre du gel hydroalcoolique directement dans l'≈ìil"},
      {key:"D", a:"Se frotter l'≈ìil pour √©vacuer le liquide"}
    ],
    answer:["B"],
    rationale:"AES = urgence. Conduite : rin√ßage imm√©diat abondant > alerte > tra√ßabilit√© > proc√©dure (bilan sanguin, consultation, d√©claration AT). Pas de SHA sur muqueuse.",
    image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='200' viewBox='0 0 600 200'%3E%3Crect fill='%230f1a31' width='600' height='200'/%3E%3Ccircle cx='100' cy='100' r='60' fill='%23ff5d7a' fill-opacity='0.15' stroke='%23ff5d7a' stroke-width='3'/%3E%3Cpath d='M85 85 Q100 70 115 85' stroke='%23ff5d7a' stroke-width='3' fill='none'/%3E%3Ccircle cx='90' cy='90' r='8' fill='%23ff5d7a'/%3E%3Ccircle cx='110' cy='90' r='8' fill='%23ff5d7a'/%3E%3Ctext x='100' y='175' fill='%23a9b7da' font-family='system-ui' font-size='11' text-anchor='middle'%3EAES%3C/text%3E%3Cpath d='M160 100 L220 100' stroke='%23ffd166' stroke-width='3' marker-end='url(%23arrow3)'/%3E%3Crect x='220' y='70' width='160' height='60' rx='8' fill='%235dd6ff' fill-opacity='0.1' stroke='%235dd6ff' stroke-width='2'/%3E%3Ctext x='300' y='95' fill='%23e8eefc' font-family='system-ui' font-size='12' text-anchor='middle'%3ERINCER 15 min%3C/text%3E%3Ctext x='300' y='115' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3Eeau abondante%3C/text%3E%3Cpath d='M380 100 L440 100' stroke='%23ffd166' stroke-width='3' marker-end='url(%23arrow3)'/%3E%3Crect x='440' y='70' width='140' height='60' rx='8' fill='%239bffb5' fill-opacity='0.1' stroke='%239bffb5' stroke-width='2'/%3E%3Ctext x='510' y='95' fill='%23e8eefc' font-family='system-ui' font-size='11' text-anchor='middle'%3EALERTER%3C/text%3E%3Ctext x='510' y='110' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3E+ Tracer%3C/text%3E%3Ctext x='510' y='125' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3E+ Proc√©dure%3C/text%3E%3Cdefs%3E%3Cmarker id='arrow3' markerWidth='10' markerHeight='10' refX='5' refY='3' orient='auto'%3E%3Cpath d='M0,0 L0,6 L9,3 z' fill='%23ffd166'/%3E%3C/marker%3E%3C/defs%3E%3C/svg%3E"
  },
  {
    id:"q6", type:"short", points: 1.5, theme:"sst", tags:["pro"],
    title:"Communication parent : message factuel et rassurant",
    subtitle:"Informer sans dramatiser, tracer les faits.",
    scenario:"16h45, cr√®che familiale. Un enfant de 2 ans se pince les doigts dans la porte du placard (fermeture brutale). L√©sion superficielle : rougeur, l√©ger gonflement. Premiers soins r√©alis√©s (eau froide, d√©sinfection l√©g√®re, surveillance). Pas de plaie ouverte.",
    prompt:"R√©dige un message court (4‚Äì6 lignes) pour les parents : contexte, faits observ√©s, actions men√©es, consignes de surveillance.",
    answerShort:{
      minWords: 40,
      mustIncludeAny:[
        ["heure","16h","survenu","vers"],
        ["pinc√©","porte","placard","doigts"],
        ["refroidi","eau","d√©sinfect√©","surveill√©","soins"],
        ["surveiller","consulter","douleur","gonflement","mobilit√©"]
      ],
      avoid:["grave","faute","proc√®s"]
    },
    rationale:"Comp√©tence professionnelle : communiquer de mani√®re factuelle (heure, lieu, circonstances), rassurer sans minimiser, transmettre une consigne de surveillance claire."
  },
  {
    id:"q7", type:"msq", points: 1.5, theme:"ppms", tags:["doc","pro"],
    title:"Alarme incendie : protocole d'√©vacuation en collectivit√©",
    subtitle:"Ma√Ætrise du groupe + proc√©dure.",
    scenario:"10h20, halte-garderie (section 2‚Äì3 ans, 12 enfants pr√©sents). Odeur inhabituelle (fum√©e l√©g√®re) + d√©clenchement de l'alarme incendie. Tu es dans le couloir avec 4 enfants. La salle de jeux (8 enfants + 1 coll√®gue) est √† 10 m√®tres.",
    prompt:"Quelles actions sont attendues dans ce contexte ? (plusieurs r√©ponses possibles)",
    choices:[
      {key:"A", a:"Appliquer l'organisation pr√©vue : regrouper les enfants, √©vacuer par l'issue d√©sign√©e, rejoindre le point de rassemblement, compter les effectifs"},
      {key:"B", a:"Retourner chercher son t√©l√©phone personnel dans le vestiaire"},
      {key:"C", a:"Fermer les portes derri√®re soi si c'est possible sans danger (limiter la propagation des fum√©es)"},
      {key:"D", a:"Se disperser pour sortir plus vite, chacun par l'issue la plus proche"},
      {key:"E", a:"Rassurer les enfants, maintenir le groupe, rester calme et directif"}
    ],
    answer:["A","C","E"],
    rationale:"√âvacuation incendie = proc√©dure + ma√Ætrise des effectifs + limitation de la propagation (fermeture des portes) + calme. On n'ajoute pas de risques.",
    image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='200' viewBox='0 0 600 200'%3E%3Crect fill='%230f1a31' width='600' height='200'/%3E%3Crect x='50' y='50' width='150' height='100' rx='8' fill='%23ff5d7a' fill-opacity='0.1' stroke='%23ff5d7a' stroke-width='2'/%3E%3Cpath d='M90 90 L90 120 M110 90 L110 120 M130 90 L130 120' stroke='%23ff5d7a' stroke-width='3'/%3E%3Cpath d='M85 85 Q95 70 105 85 Q115 70 125 85 Q135 70 145 85' stroke='%23ffd166' stroke-width='2' fill='none'/%3E%3Ctext x='125' y='170' fill='%23a9b7da' font-family='system-ui' font-size='11' text-anchor='middle'%3EALARME%3C/text%3E%3Cpath d='M200 100 L280 100' stroke='%235dd6ff' stroke-width='3' marker-end='url(%23arrow4)'/%3E%3Crect x='280' y='60' width='140' height='80' rx='8' fill='%235dd6ff' fill-opacity='0.1' stroke='%235dd6ff' stroke-width='2'/%3E%3Ctext x='350' y='85' fill='%23e8eefc' font-family='system-ui' font-size='12' text-anchor='middle'%3E√âVACUER%3C/text%3E%3Ctext x='350' y='105' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3EGroupe ma√Ætris√©%3C/text%3E%3Ctext x='350' y='120' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3EFermer portes%3C/text%3E%3Ctext x='350' y='135' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3ECalme%3C/text%3E%3Cpath d='M420 100 L480 100' stroke='%235dd6ff' stroke-width='3' marker-end='url(%23arrow4)'/%3E%3Ccircle cx='530' cy='100' r='50' fill='%239bffb5' fill-opacity='0.1' stroke='%239bffb5' stroke-width='2'/%3E%3Ctext x='530' y='105' fill='%23e8eefc' font-family='system-ui' font-size='11' text-anchor='middle'%3EPOINT DE%3C/text%3E%3Ctext x='530' y='120' fill='%23e8eefc' font-family='system-ui' font-size='11' text-anchor='middle'%3ERASSEMBLEMENT%3C/text%3E%3Cdefs%3E%3Cmarker id='arrow4' markerWidth='10' markerHeight='10' refX='5' refY='3' orient='auto'%3E%3Cpath d='M0,0 L0,6 L9,3 z' fill='%235dd6ff'/%3E%3C/marker%3E%3C/defs%3E%3C/svg%3E"
  },
  {
    id:"q8", type:"short", points: 2, theme:"ppms", tags:["doc","kpi"],
    title:"PPMS de ton √©tablissement : mission terrain professionnalisante",
    subtitle:"Recherche documentaire + restitution structur√©e.",
    scenario:"Tu es en stage/alternance dans une structure AEPE. Le formateur te demande de prouver que tu connais l'organisation s√©curit√© r√©elle de ton lieu d'exercice.",
    prompt:"R√©dige une r√©ponse structur√©e (6‚Äì8 lignes minimum) : (1) o√π se trouve le PPMS, (2) qui est le r√©f√©rent s√©curit√©, (3) point de rassemblement ext√©rieur, (4) 2 consignes cl√©s pour les pros.",
    answerShort:{
      minWords: 50,
      mustIncludeAny:[
        ["ppms","classeur","affichage","intranet","ent","direction","bureau","panneau"],
        ["r√©f√©rent","directeur","directrice","responsable","adjoint"],
        ["rassemblement","cour","parking","portail","zone","ext√©rieur"],
        ["consigne","alerte","confinement","√©vacuation","appel","comptage","signal"]
      ],
      avoid:["je ne sais pas","aucune id√©e","pas trouv√©"]
    },
    rationale:"Comp√©tence : rechercher l'information, s'approprier les proc√©dures, restituer de mani√®re exploitable. Si PPMS non trouv√© : d√©crire la d√©marche et signaler l'√©cart."
  },
  {
    id:"q9", type:"mcq", points: 1, theme:"tms", tags:["pro"],
    title:"Pr√©vention TMS : hi√©rarchie des mesures applicables",
    subtitle:"Agir sur le poste et l'organisation.",
    scenario:"Cr√®che collective, section b√©b√©s (6‚Äì18 mois). Gestes r√©p√©t√©s au sol (changes, jeux, portage), flexion lombaire fr√©quente, douleurs dorsales r√©currentes chez 3 pros sur 5.",
    prompt:"Quelle action est prioritaire selon les principes de pr√©vention des TMS ?",
    choices:[
      {key:"A", a:"Forcer : le corps finit toujours par s'habituer aux contraintes"},
      {key:"B", a:"Adapter la hauteur des plans de change, rapprocher les charges, utiliser des si√®ges ergonomiques ou appuis, organiser des rotations de postes"},
      {key:"C", a:"Prendre des antidouleurs avant chaque service"},
      {key:"D", a:"Arr√™ter toute activit√© physique en dehors du travail"}
    ],
    answer:["B"],
    rationale:"Pr√©vention TMS = agir sur les d√©terminants (poste, organisation, √©quipements) avant les compensations individuelles. Principe : supprimer ou r√©duire la contrainte √† la source.",
    image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='220' viewBox='0 0 600 220'%3E%3Crect fill='%230f1a31' width='600' height='220'/%3E%3Ctext x='300' y='25' fill='%23e8eefc' font-family='system-ui' font-size='14' font-weight='700' text-anchor='middle'%3EHI√âRARCHIE DES MESURES TMS%3C/text%3E%3Crect x='50' y='50' width='500' height='35' rx='6' fill='%239bffb5' fill-opacity='0.15' stroke='%239bffb5' stroke-width='2'/%3E%3Ctext x='70' y='73' fill='%23e8eefc' font-family='system-ui' font-size='11' font-weight='700'%3E1. SUPPRIMER / R√âDUIRE √Ä LA SOURCE%3C/text%3E%3Crect x='80' y='95' width='480' height='30' rx='6' fill='%235dd6ff' fill-opacity='0.15' stroke='%235dd6ff' stroke-width='2'/%3E%3Ctext x='100' y='115' fill='%23e8eefc' font-family='system-ui' font-size='10'%3E2. ORGANISATION + AM√âNAGEMENT%3C/text%3E%3Crect x='110' y='135' width='460' height='30' rx='6' fill='%23ffd166' fill-opacity='0.15' stroke='%23ffd166' stroke-width='2'/%3E%3Ctext x='130' y='155' fill='%23e8eefc' font-family='system-ui' font-size='10'%3E3. EPI (si mesures pr√©c√©dentes insuffisantes)%3C/text%3E%3Crect x='140' y='175' width='440' height='30' rx='6' fill='%23ff5d7a' fill-opacity='0.15' stroke='%23ff5d7a' stroke-width='2'/%3E%3Ctext x='160' y='195' fill='%23e8eefc' font-family='system-ui' font-size='10'%3E4. INFORMATION / FORMATION%3C/text%3E%3C/svg%3E"
  },
  {
    id:"q10", type:"short", points: 1.5, theme:"tms", tags:["kpi"],
    title:"Micro-plan d'action TMS : de l'observation √† l'am√©lioration pilot√©e",
    subtitle:"Mesures concr√®tes + indicateur de suivi.",
    scenario:"Multi-accueil (25 places). Observation : plans de travail encombr√©s (produits, linge, jouets), d√©placements inutiles pour atteindre le mat√©riel, chocs r√©p√©t√©s contre les meubles, fatigue en fin de journ√©e.",
    prompt:"Propose 2 actions r√©alistes (am√©nagement ou organisation) + 1 indicateur mesurable pour v√©rifier que l'am√©lioration tient dans le temps (5‚Äì7 lignes).",
    answerShort:{
      minWords: 42,
      mustIncludeAny:[
        ["rangement","5s","zone","standard","proc√©dure","check","routine","affichage","responsable"],
        ["indicateur","suivi","hebdomadaire","mensuel","taux","nombre","photo","audit","contr√¥le"]
      ],
      avoid:["on verra","faut faire attention","c'est suffisant"]
    },
    rationale:"Attendu : action concr√®te (zone de rangement d√©di√©e, check-list visuelle) + indicateur de pilotage (photo hebdomadaire, taux de conformit√©). On transforme une observation en ma√Ætrise durable."
  },
  {
    id:"q11", type:"mcq", points: 1, theme:"cadre", tags:["pro"],
    title:"Usage du t√©l√©phone personnel : posture professionnelle et surveillance",
    subtitle:"Responsabilit√© collective, recadrage constructif.",
    scenario:"15h30, halte-garderie. Un coll√®gue consulte r√©guli√®rement son t√©l√©phone en salle d'activit√© (messages, r√©seaux sociaux). Il dit : ¬´ Je garde quand m√™me un ≈ìil sur les enfants. ¬ª",
    prompt:"Quelle posture est la plus professionnelle dans ce contexte ?",
    choices:[
      {key:"A", a:"Ne rien dire : ce n'est pas ton r√¥le de recadrer un coll√®gue"},
      {key:"B", a:"Aborder le sujet factuellement (impact sur la surveillance, s√©curit√© des enfants) et proposer une organisation (pause t√©l√©phone en alternance)"},
      {key:"C", a:"Filmer la sc√®ne pour prouver le manquement"},
      {key:"D", a:"Alerter directement les parents"}
    ],
    answer:["B"],
    rationale:"Posture pro = recadrage factuel (s√©curit√©/surveillance) + solution organisationnelle. La bienveillance professionnelle n'exclut pas l'exigence."
  },
  {
    id:"q12", type:"mcq", points: 1, theme:"infectieux", tags:["risk","doc"],
    title:"Produit chimique non √©tiquet√© : STOP et proc√©dure",
    subtitle:"Risque chimique = identification obligatoire.",
    scenario:"8h15, cr√®che collective. Tu d√©couvres un flacon pulv√©risateur sans √©tiquette pr√®s de l'√©vier (cuisine). Liquide transparent, odeur javellis√©e. Dilution et origine inconnues.",
    prompt:"Quelle conduite est conforme aux r√®gles de pr√©vention du risque chimique ?",
    choices:[
      {key:"A", a:"Utiliser le produit en mettant plus d'eau pour diluer davantage"},
      {key:"B", a:"Mettre le flacon de c√¥t√©, tenter d'identifier le produit (√©tiquette, FDS, responsable), ne pas utiliser tant que l'identification n'est pas s√ªre"},
      {key:"C", a:"Sentir le produit pour deviner ce que c'est"},
      {key:"D", a:"Jeter le contenu directement dans l'√©vier"}
    ],
    answer:["B"],
    rationale:"Sans identification claire (√©tiquette, FDS), usage interdit. On s√©curise, on identifie, on applique la proc√©dure. Jamais d'improvisation avec un produit chimique.",
    image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='200' viewBox='0 0 600 200'%3E%3Crect fill='%230f1a31' width='600' height='200'/%3E%3Crect x='50' y='50' width='100' height='120' rx='8' fill='%23ff5d7a' fill-opacity='0.15' stroke='%23ff5d7a' stroke-width='3'/%3E%3Crect x='60' y='60' width='80' height='90' rx='4' fill='none' stroke='%23ff5d7a' stroke-width='2'/%3E%3Cpath d='M70 130 L130 130 L130 160 L70 160 Z' fill='%23ff5d7a' fill-opacity='0.3'/%3E%3Ctext x='100' y='95' fill='%23ff5d7a' font-family='system-ui' font-size='40' text-anchor='middle'%3E%3F%3C/text%3E%3Ctext x='100' y='185' fill='%23a9b7da' font-family='system-ui' font-size='11' text-anchor='middle'%3ENON IDENTIFI√â%3C/text%3E%3Cpath d='M150 110 L250 110' stroke='%23ffd166' stroke-width='3'/%3E%3Cpath d='M235 100 L250 110 L235 120' stroke='%23ffd166' stroke-width='3' fill='none'/%3E%3Cpath d='M250 80 L250 140' stroke='%23ff5d7a' stroke-width='4'/%3E%3Ccircle cx='250' cy='110' r='25' fill='none' stroke='%23ff5d7a' stroke-width='4'/%3E%3Ctext x='250' y='160' fill='%23ff5d7a' font-family='system-ui' font-size='14' font-weight='700' text-anchor='middle'%3ESTOP%3C/text%3E%3Crect x='350' y='60' width='200' height='90' rx='8' fill='%239bffb5' fill-opacity='0.1' stroke='%239bffb5' stroke-width='2'/%3E%3Ctext x='450' y='85' fill='%23e8eefc' font-family='system-ui' font-size='12' text-anchor='middle'%3EIDENTIFIER%3C/text%3E%3Ctext x='450' y='105' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3E√âtiquette + FDS%3C/text%3E%3Ctext x='450' y='120' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3EResponsable%3C/text%3E%3Ctext x='450' y='135' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3EProc√©dure%3C/text%3E%3C/svg%3E"
  },
  {
    id:"q13", type:"short", points: 1, theme:"cadre", tags:["kpi","pro"],
    title:"Faits vs interpr√©tation : m√©thode d'analyse professionnelle",
    subtitle:"Observer avant de juger.",
    scenario:"10h45, cr√®che. Un enfant (2 ans 1/2) court dans le couloir et tombe en heurtant le coin d'un meuble. L√©ger h√©matome front, enfant rassur√©. Un adulte dit : ¬´ Il est toujours excit√©, c'est sa faute, il fonce tout le temps. ¬ª",
    prompt:"R√©dige une r√©ponse structur√©e (4‚Äì6 lignes) : 2 faits observables + 2 hypoth√®ses organisation/environnement √† v√©rifier (sans jugement de valeur).",
    answerShort:{
      minWords: 35,
      mustIncludeAny:[
        ["fait","observ√©","vu","constat√©","couloir","meuble","coin","heurt√©","couru"],
        ["hypoth√®se","v√©rifier","organisation","am√©nagement","signalisation","encombrement","supervision","circulation"]
      ],
      avoid:["c'est sa faute","toujours pareil","excit√©"]
    },
    rationale:"On distingue l'observable (faits : heure, lieu, action, r√©sultat) et l'explicatif (hypoth√®ses : organisation de l'espace, signalisation, supervision). La pr√©vention durable na√Æt de cette discipline."
  },
  {
    id:"q14", type:"msq", points: 1.5, theme:"cadre", tags:["risk"],
    title:"Risque √©lectrique : rep√©rer, s√©curiser, signaler",
    subtitle:"Pas de bricolage, intervention qualifi√©e.",
    scenario:"Salle de motricit√©, cr√®che collective. Constat : prise murale fissur√©e + rallonge √©lectrique enroul√©e serr√©e (chauffe) sous un tapis de sol.",
    prompt:"Quelles actions sont pertinentes dans ce contexte ? (plusieurs r√©ponses possibles)",
    choices:[
      {key:"A", a:"Interdire l'usage de la zone concern√©e, s√©curiser (rubalise, panneau), signaler au responsable, demander intervention d'un √©lectricien qualifi√©"},
      {key:"B", a:"R√©parer toi-m√™me la prise avec du scotch"},
      {key:"C", a:"Retirer le tapis et d√©rouler compl√®tement la rallonge si elle doit rester temporairement (√©viter √©chauffement), mais pr√©voir suppression rapide"},
      {key:"D", a:"Ignorer : √ßa n'a jamais pos√© de probl√®me avant"}
    ],
    answer:["A","C"],
    rationale:"On s√©curise, on supprime le danger imm√©diat si possible (d√©rouler rallonge), on alerte la hi√©rarchie, on demande une intervention qualifi√©e. Jamais de r√©paration √©lectrique par un non-habilit√©.",
    image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='200' viewBox='0 0 600 200'%3E%3Crect fill='%230f1a31' width='600' height='200'/%3E%3Cg%3E%3Ccircle cx='120' cy='100' r='70' fill='%23ffd166' fill-opacity='0.1' stroke='%23ffd166' stroke-width='3'/%3E%3Cpath d='M105 70 L120 100 L105 100 L120 130' stroke='%23ffd166' stroke-width='4' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Ctext x='120' y='185' fill='%23a9b7da' font-family='system-ui' font-size='11' text-anchor='middle'%3ERISQUE%3C/text%3E%3C/g%3E%3Cpath d='M190 100 L280 100' stroke='%235dd6ff' stroke-width='3' marker-end='url(%23arrow5)'/%3E%3Crect x='280' y='60' width='140' height='80' rx='8' fill='%23ff5d7a' fill-opacity='0.1' stroke='%23ff5d7a' stroke-width='2'/%3E%3Ctext x='350' y='90' fill='%23e8eefc' font-family='system-ui' font-size='13' font-weight='700' text-anchor='middle'%3ES√âCURISER%3C/text%3E%3Ctext x='350' y='108' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3EInterdire zone%3C/text%3E%3Ctext x='350' y='123' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3ESignaler%3C/text%3E%3Cpath d='M420 100 L480 100' stroke='%235dd6ff' stroke-width='3' marker-end='url(%23arrow5)'/%3E%3Crect x='480' y='70' width='100' height='60' rx='8' fill='%239bffb5' fill-opacity='0.1' stroke='%239bffb5' stroke-width='2'/%3E%3Ctext x='530' y='95' fill='%23e8eefc' font-family='system-ui' font-size='11' text-anchor='middle'%3EINTERVENTION%3C/text%3E%3Ctext x='530' y='110' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3Equalifi√©e%3C/text%3E%3Cdefs%3E%3Cmarker id='arrow5' markerWidth='10' markerHeight='10' refX='5' refY='3' orient='auto'%3E%3Cpath d='M0,0 L0,6 L9,3 z' fill='%235dd6ff'/%3E%3C/marker%3E%3C/defs%3E%3C/svg%3E"
  },
  {
    id:"q15", type:"msq", points: 1.5, theme:"infectieux", tags:["risk","doc"],
    title:"PAI allergie alimentaire : cadre strict, z√©ro improvisation",
    subtitle:"Protocole = s√©curit√© de l'enfant.",
    scenario:"Go√ªter anniversaire, multi-accueil. Un parent apporte un g√¢teau maison (ingr√©dients non pr√©cis√©s). Un enfant du groupe a un PAI (allergie ≈ìuf et arachide).",
    prompt:"Quelles actions sont coh√©rentes avec la gestion d'un PAI ? (plusieurs r√©ponses possibles)",
    choices:[
      {key:"A", a:"V√©rifier le PAI, interroger le parent sur les ingr√©dients exacts, √©valuer le risque de contamination crois√©e"},
      {key:"B", a:"Faire go√ªter un tout petit morceau pour tester la r√©action"},
      {key:"C", a:"Pr√©voir syst√©matiquement une alternative s√ªre et conforme au PAI pour l'enfant allergique"},
      {key:"D", a:"Informer l'√©quipe pr√©sente et tracer l'√©v√©nement si besoin (cahier de liaison, registre)"}
    ],
    answer:["A","C","D"],
    rationale:"PAI = protocole strict. Pas de test improvis√© (r√©action potentiellement grave). On anticipe, on s√©curise, on trace. La responsabilit√© est engag√©e.",
    image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='200' viewBox='0 0 600 200'%3E%3Crect fill='%230f1a31' width='600' height='200'/%3E%3Crect x='50' y='50' width='150' height='100' rx='8' fill='%23ff5d7a' fill-opacity='0.12' stroke='%23ff5d7a' stroke-width='2'/%3E%3Ctext x='125' y='75' fill='%23e8eefc' font-family='system-ui' font-size='13' font-weight='700' text-anchor='middle'%3EPAI%3C/text%3E%3Ctext x='125' y='95' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3E≈íuf%3C/text%3E%3Ctext x='125' y='110' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3EArachide%3C/text%3E%3Ctext x='125' y='125' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3ETraces%3C/text%3E%3Ctext x='125' y='140' fill='%23ff5d7a' font-family='system-ui' font-size='10' font-weight='700' text-anchor='middle'%3EURGENCE%3C/text%3E%3Cpath d='M200 100 L320 100' stroke='%235dd6ff' stroke-width='3' marker-end='url(%23arrow6)'/%3E%3Crect x='320' y='60' width='240' height='80' rx='8' fill='%239bffb5' fill-opacity='0.1' stroke='%239bffb5' stroke-width='2'/%3E%3Ctext x='440' y='85' fill='%23e8eefc' font-family='system-ui' font-size='12' text-anchor='middle'%3EPROTOCOLE STRICT%3C/text%3E%3Ctext x='440' y='103' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3EV√©rifier ingr√©dients%3C/text%3E%3Ctext x='440' y='118' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3EAlternative s√ªre%3C/text%3E%3Ctext x='440' y='133' fill='%23a9b7da' font-family='system-ui' font-size='10' text-anchor='middle'%3ETracer%3C/text%3E%3Cdefs%3E%3Cmarker id='arrow6' markerWidth='10' markerHeight='10' refX='5' refY='3' orient='auto'%3E%3Cpath d='M0,0 L0,6 L9,3 z' fill='%235dd6ff'/%3E%3C/marker%3E%3C/defs%3E%3C/svg%3E"
  },
  {
    id:"q16", type:"msq", points: 1.5, theme:"cadre", tags:["risk"],
    title:"Chute de plain-pied : identifier les facteurs contributifs r√©els",
    subtitle:"Multi-causalit√© = analyse syst√©mique.",
    scenario:"14h15, halte-garderie. Activit√© peinture termin√©e. Sol humide (nettoyage en cours). Un enfant glisse l√©g√®rement en se relevant (sans chute). Aucun bless√©.",
    prompt:"Quels facteurs augmentent r√©ellement le risque de chute dans ce contexte ? (plusieurs r√©ponses possibles)",
    choices:[
      {key:"A", a:"Sol humide ou produit de nettoyage mal rinc√© (√©tat de surface)"},
      {key:"B", a:"Circulation encombr√©e (mat√©riel, mobilier mal rang√©)"},
      {key:"C", a:"Chaussures antid√©rapantes port√©es par les adultes"},
      {key:"D", a:"Absence de signalisation temporaire (panneau ¬´ sol glissant ¬ª)"},
      {key:"E", a:"L'enfant a couru : c'est la seule cause"}
    ],
    answer:["A","B","D"],
    rationale:"On retient les facteurs mat√©riels (sol), organisationnels (circulation, rangement) et informationnels (signalisation). Les chaussures antid√©rapantes sont une mesure de pr√©vention. Le comportement seul est rarement l'unique cause."
  },
  {
    id:"q17", type:"msq", points: 1.5, theme:"ppms", tags:["doc"],
    title:"PPMS : appropriation collective et mise √† jour",
    subtitle:"Un document vivant, pas une archive.",
    scenario:"Rentr√©e septembre. Arriv√©e de 3 stagiaires et 1 alternante. Aucune n'a eu acc√®s au PPMS ni aux consignes d'√©vacuation/confinement.",
    prompt:"Quelles actions permettent une appropriation efficace du PPMS par l'√©quipe ? (plusieurs r√©ponses possibles)",
    choices:[
      {key:"A", a:"Identifier l'emplacement et les modalit√©s d'acc√®s (classeur direction, affichage, ENT, intranet)"},
      {key:"B", a:"Organiser un rappel collectif : signaux d'alerte, r√¥les de chacun, zones de rassemblement/confinement"},
      {key:"C", a:"Attendre qu'un incident se produise pour d√©couvrir les consignes"},
      {key:"D", a:"V√©rifier la mise √† jour des coordonn√©es d'urgence (services, parents, √©quipe)"},
      {key:"E", a:"Cacher le document pour √©viter que les stagiaires posent trop de questions"}
    ],
    answer:["A","B","D"],
    rationale:"PPMS efficace = accessibilit√© + appropriation (formation, rappel) + mise √† jour r√©guli√®re + entra√Ænement. Les stagiaires doivent √™tre int√©gr√©s d√®s leur arriv√©e."
  },
  {
    id:"q18", type:"mcq", points: 1, theme:"cadre", tags:["doc"],
    title:"Douleur lombaire en situation : tra√ßabilit√© et pr√©vention",
    subtitle:"Culture de d√©claration = protection collective.",
    scenario:"11h, cr√®che. Tu soul√®ves un bac de jeux lourd (15 kg, mal rang√© au sol). Douleur lombaire imm√©diate, blocage partiel.",
    prompt:"Quelle conduite est la plus professionnelle dans ce contexte ?",
    choices:[
      {key:"A", a:"Ne rien dire pour ne pas d√©ranger l'√©quipe"},
      {key:"B", a:"Informer imm√©diatement le responsable, tracer l'incident, consulter si n√©cessaire, analyser les causes (organisation, port de charge, am√©nagement)"},
      {key:"C", a:"Attendre 15 jours pour voir si √ßa passe"},
      {key:"D", a:"Poster sur les r√©seaux sociaux pour d√©noncer les conditions de travail"}
    ],
    answer:["B"],
    rationale:"Informer + tracer sert la pr√©vention collective et la sant√© individuelle. Si accident du travail : d√©claration obligatoire. On analyse ensuite l'organisation et le poste."
  },
  {
    id:"q19", type:"mcq", points: 1, theme:"infectieux", tags:["pro"],
    title:"√âpisode de gastro-ent√©rite : protocole et organisation",
    subtitle:"Hygi√®ne renforc√©e + limitation de la transmission.",
    scenario:"9h45, cr√®che collective. Deux enfants (section 12‚Äì18 mois) pr√©sentent vomissements dans un d√©lai de 30 minutes. Tu es en renfort ce matin.",
    prompt:"Quel r√©flexe est le plus adapt√© dans ce contexte ?",
    choices:[
      {key:"A", a:"Nettoyer rapidement sans changer de gants entre les deux zones"},
      {key:"B", a:"Appliquer le protocole : isolement des enfants malades si possible, hygi√®ne des mains renforc√©e, d√©sinfection adapt√©e des surfaces, gestion des d√©chets souill√©s, information imm√©diate √©quipe et parents"},
      {key:"C", a:"Continuer normalement : √ßa finira par passer"},
      {key:"D", a:"Mettre du parfum d'ambiance pour masquer les odeurs"}
    ],
    answer:["B"],
    rationale:"√âpisode infectieux = protocole + organisation + hygi√®ne stricte. On limite la transmission (isolement si possible, hygi√®ne des mains, d√©sinfection, gestion des d√©chets) et on trace."
  },
  {
    id:"q20", type:"short", points: 2, theme:"cadre", tags:["kpi","doc"],
    title:"Hi√©rarchie des mesures de pr√©vention : principe fondamental PSE",
    subtitle:"Du plus efficace (source) au moins efficace (comportement).",
    scenario:"Un risque professionnel a √©t√© identifi√© dans ta structure (exemples : chute, coupure, exposition chimique, TMS‚Ä¶). On te demande de proposer une d√©marche de pr√©vention structur√©e.",
    prompt:"Explique en 7‚Äì10 lignes la logique de hi√©rarchisation des mesures : supprimer/ma√Ætriser √† la source ‚Üí mesures organisationnelles/collectives ‚Üí protections individuelles (EPI) ‚Üí information/consignes. Illustre avec 1 exemple concret en structure AEPE.",
    answerShort:{
      minWords: 65,
      mustIncludeAny:[
        ["supprimer","√©liminer","source","ma√Ætriser","substituer"],
        ["organisation","am√©nagement","proc√©dure","collectif","planification"],
        ["epi","gants","protection","√©quipement","individuel"],
        ["consigne","information","sensibilisation","formation","comportement"]
      ],
      avoid:["on fait attention","c'est suffisant"]
    },
    rationale:"Hi√©rarchie PSE : (1) Supprimer ou r√©duire le danger √† la source, (2) Mesures organisationnelles/collectives, (3) EPI si insuffisant, (4) Information/formation. Exemple AEPE : risque de chute ‚Üí (1) supprimer obstacle, (2) organiser circulation/rangement, (3) chaussures antid√©rapantes si n√©cessaire, (4) sensibiliser l'√©quipe."
  }
];

function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

let currentFilter = "all";
let locked = false;

const elQ = document.getElementById("questions");
const elBar = document.getElementById("bar");
const elProgressText = document.getElementById("progressText");
const elBtnCorrect = document.getElementById("btnCorrect");
const elResults = document.getElementById("results");
const elScoreBig = document.getElementById("scoreBig");
const elScoreMeta = document.getElementById("scoreMeta");
const elKpiOk = document.getElementById("kpiOk");
const elKpiPts = document.getElementById("kpiPts");
const elKpiRate = document.getElementById("kpiRate");
const elCorrList = document.getElementById("corrList");
const elCopyState = document.getElementById("copyState");
const elBtnGoResults = document.getElementById("btnGoResults");
const elNom = document.getElementById("nom");
const elPrenom = document.getElementById("prenom");
const elClasse = document.getElementById("classe");
const elDate = document.getElementById("date");
const elEmailFormateur = document.getElementById("emailFormateur");
const elLockState = document.getElementById("lockState");
const btnLock = document.getElementById("btnLock");
const btnUnlock = document.getElementById("btnUnlock");
const btnReset = document.getElementById("btnReset");
const btnMail = document.getElementById("btnMail");
const btnCopy = document.getElementById("btnCopy");
const btnCollapse = document.getElementById("btnCollapse");
const elMode = document.getElementById("mode");
const btnGoConsignes = document.getElementById("btnGoConsignes");
const btnGoQuestions = document.getElementById("btnGoQuestions");
const btnGoResults = document.getElementById("btnGoResults");

function render(){
  const list = currentFilter === "all" ? QUESTIONS : QUESTIONS.filter(q => q.theme === currentFilter);
  
  elQ.innerHTML = list.map((q, idx) => {
    const tags = (q.tags||[]).map(t=>{
      const cls = t==="kpi" ? "kpi" : t==="risk" ? "risk" : t==="doc" ? "doc" : "pro";
      return `<span class="tag ${cls}">${escapeHtml(t.toUpperCase())}</span>`;
    }).join("");
    const pts = `<span class="tag">${q.points} pt${q.points>1?"s":""}</span>`;

    let body = "";
    if(q.type === "mcq" || q.type === "msq"){
      const inputType = q.type === "mcq" ? "radio" : "checkbox";
      body = `
        <div class="scenario">
          <p class="h">Contexte professionnel</p>
          <p class="p">${escapeHtml(q.scenario)}</p>
        </div>
        ${q.image ? `<img src="${q.image}" alt="Visuel p√©dagogique" class="visualImg" style="max-width:600px;"/>` : ''}
        <p style="margin:10px 0 0; font-weight:900;">${escapeHtml(q.prompt)}</p>
        <div class="choices">
          ${q.choices.map(c => `
            <label class="choice">
              <input type="${inputType}" name="${q.id}" value="${c.key}" />
              <div class="ct">
                <div class="a">${escapeHtml(c.key)} ‚Äî ${escapeHtml(c.a)}</div>
              </div>
            </label>
          `).join("")}
        </div>
      `;
    } else {
      body = `
        <div class="scenario">
          <p class="h">Contexte professionnel</p>
          <p class="p">${escapeHtml(q.scenario)}</p>
        </div>
        <p style="margin:10px 0 0; font-weight:900;">${escapeHtml(q.prompt)}</p>
        <textarea id="${q.id}__text" placeholder="R√©dige une r√©ponse professionnelle structur√©e..."></textarea>
        <div class="pill" style="margin-top:8px;">Structure : faits ‚Üí analyse ‚Üí action(s) ‚Üí tra√ßabilit√©</div>
      `;
    }

    return `
      <details data-q="${q.id}">
        <summary>
          <div class="qTitle">
            <div class="qNum">${idx+1}</div>
            <div class="qMeta">
              <p class="t">${escapeHtml(q.title)}</p>
              <p class="s">${escapeHtml(q.subtitle)}</p>
            </div>
          </div>
          <div class="qRight">${pts}${tags}</div>
        </summary>
        <div class="qBody">${body}</div>
      </details>
    `;
  }).join("");

  wireProgress();
}

function allRequiredFilled(){
  return elNom.value.trim().length>0 && elPrenom.value.trim().length>0 && elDate.value.trim().length>0;
}

function setLock(state){
  locked = state;
  [elNom, elPrenom, elClasse, elDate, elEmailFormateur].forEach(el => el.disabled = state);
  btnLock.disabled = state;
  btnUnlock.disabled = !state;
  elLockState.innerHTML = `Statut : <b>${state ? "verrouill√©" : "non verrouill√©"}</b>`;
}

function wireProgress(){
  const inputs = document.querySelectorAll('input[type="radio"], input[type="checkbox"], textarea');
  inputs.forEach(el => el.addEventListener("input", updateProgress));
  updateProgress();
}

function answeredCount(){
  let answered = 0;
  for(const q of QUESTIONS){
    if(q.type==="mcq"){
      const sel = document.querySelector(`input[name="${q.id}"]:checked`);
      if(sel) answered++;
    } else if(q.type==="msq"){
      const sel = document.querySelectorAll(`input[name="${q.id}"]:checked`);
      if(sel.length>0) answered++;
    } else {
      const t = document.getElementById(`${q.id}__text`);
      if(t && t.value.trim().length>0) answered++;
    }
  }
  return answered;
}

function updateProgress(){
  const total = QUESTIONS.length;
  const ans = answeredCount();
  const pct = Math.round((ans/total)*100);
  elBar.style.width = pct + "%";
  elProgressText.innerHTML = `Progression : <b>${pct}%</b>`;
  elBtnCorrect.disabled = !(allRequiredFilled());
}

function normalize(s){
  return (s||"").toLowerCase()
    .normalize("NFD").replace(/\p{Diacritic}/gu,"")
    .replace(/[^\p{L}\p{N}\s-]/gu," ")
    .replace(/\s+/g," ")
    .trim();
}

function scoreShort(q, text){
  const t = normalize(text);
  const words = t.length ? t.split(" ").length : 0;
  let okBlocks = 0;

  if(q.answerShort && Array.isArray(q.answerShort.mustIncludeAny)){
    for(const block of q.answerShort.mustIncludeAny){
      const found = block.some(term => t.includes(normalize(term)));
      if(found) okBlocks++;
    }
  }
  const minWords = q.answerShort?.minWords ?? 0;
  const avoid = q.answerShort?.avoid ?? [];
  const hasAvoid = avoid.some(term => t.includes(normalize(term)));

  const blocksTotal = (q.answerShort?.mustIncludeAny?.length ?? 0) || 1;
  const blockScore = okBlocks / blocksTotal;
  const lenScore = minWords ? Math.min(1, words / minWords) : 1;

  let raw = 0.6*blockScore + 0.4*lenScore;
  if(hasAvoid) raw = Math.max(0, raw - 0.25);

  const pts = q.points * raw;
  return { pts, raw, words, okBlocks, blocksTotal, hasAvoid };
}

function getSelected(q){
  if(q.type==="mcq"){
    const sel = document.querySelector(`input[name="${q.id}"]:checked`);
    return sel ? [sel.value] : [];
  }
  if(q.type==="msq"){
    const sel = [...document.querySelectorAll(`input[name="${q.id}"]:checked`)];
    return sel.map(x=>x.value);
  }
  const t = document.getElementById(`${q.id}__text`);
  return t ? [t.value] : [""];
}

function arraysEqualAsSets(a,b){
  const sa = new Set(a);
  const sb = new Set(b);
  if(sa.size !== sb.size) return false;
  for(const x of sa) if(!sb.has(x)) return false;
  return true;
}

function calcTotalPoints(){ return QUESTIONS.reduce((s,q)=>s+q.points,0); }

function formatScoreOn20(points){
  const total = calcTotalPoints();
  const on20 = (points/total)*20;
  return Math.round(on20*10)/10;
}

function nowStr(){
  const d = new Date();
  const pad = (n)=>String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function correct(){
  if(!allRequiredFilled()){ alert("Cartouche incomplet : Nom, Pr√©nom et Date obligatoires."); return; }

  const mode = elMode.value;
  let points = 0;
  let validCount = 0;
  const corrItems = [];

  for(let i=0;i<QUESTIONS.length;i++){ 
    const q = QUESTIONS[i];
    const user = getSelected(q);

    if(q.type==="mcq" || q.type==="msq"){
      const ok = arraysEqualAsSets(user, q.answer);
      const got = ok ? q.points : 0;
      points += got;
      if(ok) validCount++;
      corrItems.push({
        idx: i+1, title: q.title, ok, got, max: q.points,
        expected: q.answer.join(", "),
        given: user.length ? user.join(", ") : "‚Äî",
        rationale: q.rationale
      });
    } else {
      const txt = user[0] || "";
      const r = scoreShort(q, txt);
      points += r.pts;
      const ok = r.raw >= 0.70 && txt.trim().length>0;
      if(ok) validCount++;
      corrItems.push({
        idx:i+1, title:q.title, ok,
        got: Math.round(r.pts*10)/10, max:q.points,
        expected:"R√©ponse professionnelle structur√©e.",
        given: txt.trim().length ? "R√©dig√©e" : "‚Äî",
        rationale: q.rationale + (mode==="entrainement"
          ? ` (Auto: ${r.okBlocks}/${r.blocksTotal} blocs, ${r.words} mots, p√©nalit√©: ${r.hasAvoid?"oui":"non"}).`
          : "")
      });
    }
  }

  const total = calcTotalPoints();
  const score20 = formatScoreOn20(points);
  const rate = Math.round((points/total)*100);

  elResults.classList.add("show");
  elBtnGoResults.disabled = false;

  elScoreBig.innerHTML = `${score20} <span>/20</span>`;
  elScoreMeta.textContent = `${elNom.value.trim().toUpperCase()} ${elPrenom.value.trim()} ‚Äî ${elClasse.value.trim()||"‚Äî"} ‚Äî ${nowStr()} ‚Äî Mode: ${elMode.value}`;
  elKpiOk.textContent = `${validCount} / ${QUESTIONS.length}`;
  elKpiPts.textContent = `${Math.round(points*10)/10} / ${total}`;
  elKpiRate.textContent = `${rate}%`;

  elCorrList.innerHTML = corrItems.map(ci => `
    <div class="corrItem">
      <div class="topline">
        <div style="display:flex; gap:10px; align-items:center;">
          <span class="qNum" style="width:30px;height:30px;border-radius:10px;">${ci.idx}</span>
          <strong style="font-size:13px;">${escapeHtml(ci.title)}</strong>
        </div>
        <span class="chipRes ${ci.ok ? "ok" : "no"}">${ci.ok ? "OK" : "√Ä REVOIR"} ‚Ä¢ ${ci.got}/${ci.max}</span>
      </div>
      <h4>Justification</h4>
      <p>${escapeHtml(ci.rationale)}</p>
      <div class="divider"></div>
      <p><strong>Attendu :</strong> ${escapeHtml(ci.expected)}</p>
      <p><strong>Ta r√©ponse :</strong> ${escapeHtml(ci.given)}</p>
    </div>
  `).join("");

  const resultText =
`CAP AEPE ‚Äì PSE V3 ‚Äì R√©sultats
Stagiaire : ${elNom.value.trim().toUpperCase()} ${elPrenom.value.trim()}
Classe : ${elClasse.value.trim()||"‚Äî"}
Date : ${elDate.value} | ${nowStr()}
Mode : ${elMode.value}

Score : ${score20}/20
Points : ${Math.round(points*10)/10}/${total} | R√©ussite : ${rate}%
Questions valid√©es : ${validCount}/${QUESTIONS.length}

Points √† consolider :
${corrItems.filter(x=>!x.ok).slice(0,6).map(x=>`- Q${x.idx} ${x.title} (${x.got}/${x.max})`).join("\n") || "- Aucun point faible majeur."}`;

  elResults.dataset.resultText = resultText;
  document.getElementById("results").scrollIntoView({behavior:"smooth", block:"start"});
}

function mailResults(){
  const to = elEmailFormateur.value.trim();
  if(!to){ alert("Renseigne l'email formateur dans le cartouche."); return; }
  const subject = `CAP AEPE PSE V3 ‚Äì R√©sultats ‚Äì ${elNom.value.trim().toUpperCase()} ${elPrenom.value.trim()}`;
  const body = elResults.dataset.resultText || "";
  window.location.href = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

async function copyResults(){
  const txt = elResults.dataset.resultText || "";
  try{
    await navigator.clipboard.writeText(txt);
    elCopyState.innerHTML = `Copie : <b>OK</b>`;
    setTimeout(()=> elCopyState.innerHTML = `Copie : <b>‚Äî</b>`, 2000);
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    elCopyState.innerHTML = `Copie : <b>OK</b>`;
    setTimeout(()=> elCopyState.innerHTML = `Copie : <b>‚Äî</b>`, 2000);
  }
}

function resetAll(){
  if(!confirm("R√©initialiser : toutes les r√©ponses seront effac√©es. Continuer ?")) return;
  document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(i => i.checked = false);
  document.querySelectorAll('textarea').forEach(t => t.value = "");
  setLock(false);
  elNom.value = ""; elPrenom.value = ""; elClasse.value = "";
  const d = new Date(); const pad = (n)=>String(n).padStart(2,"0");
  elDate.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  elResults.classList.remove("show");
  elCorrList.innerHTML = "";
  elResults.dataset.resultText = "";
  elBtnGoResults.disabled = true;
  updateProgress();
  window.scrollTo({top:0, behavior:"smooth"});
}

function collapseAll(){
  document.querySelectorAll("details").forEach(d => d.open = false);
  document.getElementById("sectionQuestions").scrollIntoView({behavior:"smooth", block:"start"});
}

function init(){
  const d = new Date(); const pad = (n)=>String(n).padStart(2,"0");
  elDate.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  btnGoConsignes.addEventListener("click", ()=> document.getElementById("sectionConsignes").scrollIntoView({behavior:"smooth", block:"start"}));
  btnGoQuestions.addEventListener("click", ()=> document.getElementById("sectionQuestions").scrollIntoView({behavior:"smooth", block:"start"}));
  btnGoResults.addEventListener("click", ()=> document.getElementById("results").scrollIntoView({behavior:"smooth", block:"start"}));

  document.querySelectorAll(".tab").forEach(t=> {
    t.addEventListener("click", ()=> {
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      currentFilter = t.dataset.filter;
      render();
      document.getElementById("sectionQuestions").scrollIntoView({behavior:"smooth", block:"start"});
    });
  });

  render();

  [elNom, elPrenom, elDate].forEach(el => el.addEventListener("input", updateProgress));
  elClasse.addEventListener("input", updateProgress);

  btnLock.addEventListener("click", ()=> {
    if(!allRequiredFilled()){ alert("Renseigne Nom, Pr√©nom et Date avant de verrouiller."); return; }
    setLock(true);
  });
  btnUnlock.addEventListener("click", ()=> setLock(false));

  elBtnCorrect.addEventListener("click", correct);
  btnMail.addEventListener("click", mailResults);
  btnCopy.addEventListener("click", copyResults);
  btnReset.addEventListener("click", resetAll);
  btnCollapse.addEventListener("click", collapseAll);

  updateProgress();
}

init();
</script>
</body>
</html>